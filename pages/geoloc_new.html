<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Postos de Saúde - Recife</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="../style/geolocalicao/geoloc.css">
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="index.html"><img src="../assets/images/logo.png" alt="Logotipo"></a>
            </div>

            <button class="hamburger" id="hamburger-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <ul id="nav-menu">
                <li><a href="index.html">Início</a></li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle">Serviços</a>
                    <ul class="dropdown-menu hidden">
                        <li><a href="./atend_esp.html">Atendimento especializado</a></li>
                        <li><a href="./servicos_disponiveis.html">Serviços disponíveis</a></li>
                        <li><a href="./pages/geoloc.html">Geolocalização</a></li>
                        <li><a href="./farm.html">Medicamentos</a></li>
                        <li><a href="./pag_de_inf.html">Página de Informações</a></li>
                    </ul>
                </li>
                <li><a href="#">Contato</a></li>
                <li><a href="#">Sobre nós</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Postos de Saúde do Recife</h1>
        <p class="info">Dados locais - Atualizado em 2023</p>
        <div class="search-container">
            <input class="btn2" type="text" id="bairro" placeholder="Digite um bairro (ex: Boa Viagem, Santo Amaro)">
            <input class="btn2" type="text" id="cep" placeholder="Digite seu CEP" maxlength="9">
            <button class="btn1" onclick="buscarPostos()">Buscar por Bairro</button>
            <button onclick="buscarPorCEP()" class="search-button">Buscar por CEP</button>
            <div id="feedback" class="feedback"></div>
        </div>

        <div id="distancia-info"></div>
        <div id="map"></div>
        <div id="resultados"></div>

        <div id="lista-unidades">
            <h3>Unidades mais próximas</h3>
            <div id="unidades-proximas"></div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Configurações do mapa
        const RECIFE_CENTER = [-8.0522, -34.8828];
        const RECIFE_ZOOM = 13;
        let map;
        let markers = [];
        let allPostos = [];

        // Função para formatar CEP
        function formatarCEP(cep) {
            cep = cep.replace(/\D/g, '');
            if (cep.length > 8) cep = cep.slice(0, 8);
            if (cep.length > 5) {
                return cep.slice(0, 5) + '-' + cep.slice(5);
            }
            return cep;
        }

        // Função para validar CEP
        function validarCEP(cep) {
            const cepLimpo = cep.replace(/\D/g, '');
            return cepLimpo.length === 8;
        }

        // Busca coordenadas pelo CEP
        async function buscarCoordenadas(cep) {
            const cepLimpo = cep.replace(/\D/g, '');
            if (!validarCEP(cep)) {
                throw new Error('CEP inválido');
            }

            try {
                const responseCEP = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
                const dataCEP = await responseCEP.json();
                
                if (dataCEP.erro) {
                    throw new Error('CEP não encontrado');
                }

                const query = `${dataCEP.logradouro}, ${dataCEP.bairro}, Recife, PE, Brasil`;
                const responseNominatim = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const dataNominatim = await responseNominatim.json();

                if (dataNominatim.length === 0) {
                    throw new Error('Endereço não encontrado');
                }

                return {
                    lat: parseFloat(dataNominatim[0].lat),
                    lon: parseFloat(dataNominatim[0].lon)
                };
            } catch (error) {
                throw new Error('Erro ao buscar localização: ' + error.message);
            }
        }

        // Função para mostrar feedback visual
        function mostrarFeedback(mensagem, tipo = 'info') {
            const feedbackDiv = document.getElementById('feedback');
            feedbackDiv.textContent = mensagem;
            feedbackDiv.className = `feedback ${tipo}`;
            feedbackDiv.style.display = 'block';
            setTimeout(() => {
                feedbackDiv.style.display = 'none';
            }, 5000);
        }

        // Inicializa o mapa
        async function initMap() {
            map = L.map('map').setView(RECIFE_CENTER, RECIFE_ZOOM);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            try {
                const response = await fetch('../data/unidades_saude.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const geoJsonData = await response.json();
                processarDados(geoJsonData);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                mostrarFeedback('Erro ao carregar dados dos postos de saúde', 'error');
            }
        }

        // Processa os dados do GeoJSON
        function processarDados(geoJsonData) {
            allPostos = geoJsonData.features.map(feature => {
                const coords = feature.geometry.coordinates[0];
                const lat = coords.reduce((sum, point) => sum + point[1], 0) / coords.length;
                const lng = coords.reduce((sum, point) => sum + point[0], 0) / coords.length;
                
                return {
                    nome: feature.properties.NMUNIDAD,
                    endereco: feature.properties.NMENDUNID,
                    tipo: feature.properties.CDTIPO,
                    latitude: lat,
                    longitude: lng
                };
            });

            console.log('Postos processados:', allPostos);
        }

        // Calcula distância usando Haversine
        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Limpa marcadores do mapa
        function limparMarcadores() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // Mostra lista de unidades próximas
        function mostrarUnidadesProximas(unidades) {
            const container = document.getElementById('unidades-proximas');
            container.innerHTML = '';
            
            unidades.forEach((unidade, index) => {
                const unidadeDiv = document.createElement('div');
                unidadeDiv.className = 'unidade-item';
                unidadeDiv.innerHTML = `
                    <h4>${index + 1}. ${unidade.nome}</h4>
                    <p>Distância: ${unidade.distancia.toFixed(2)} km</p>
                    <p>Endereço: ${unidade.endereco}</p>
                `;
                
                unidadeDiv.addEventListener('click', () => {
                    map.setView([unidade.latitude, unidade.longitude], 16);
                    markers.forEach(marker => {
                        if (marker.getLatLng().lat === unidade.latitude && 
                            marker.getLatLng().lng === unidade.longitude) {
                            marker.openPopup();
                        }
                    });
                });
                
                container.appendChild(unidadeDiv);
            });
        }

        // Busca por CEP
        async function buscarPorCEP() {
            const cepInput = document.getElementById('cep');
            const cep = cepInput.value;

            if (!validarCEP(cep)) {
                mostrarFeedback('Digite um CEP válido', 'error');
                return;
            }

            try {
                mostrarFeedback('Buscando localização...', 'info');
                const coords = await buscarCoordenadas(cep);
                
                limparMarcadores();

                // Adiciona marcador do usuário
                const userMarker = L.marker([coords.lat, coords.lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41]
                    })
                }).addTo(map);
                markers.push(userMarker);

                // Calcula distâncias e ordena
                const unidadesOrdenadas = allPostos.map(posto => {
                    const dist = calcularDistancia(coords.lat, coords.lon, 
                        posto.latitude, posto.longitude);
                    return { ...posto, distancia: dist };
                }).sort((a, b) => a.distancia - b.distancia);

                // Mostra as 5 mais próximas
                const unidadesProximas = unidadesOrdenadas.slice(0, 5);
                unidadesProximas.forEach(posto => {
                    const marker = L.marker([posto.latitude, posto.longitude])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${posto.nome}</strong><br>
                            Distância: ${posto.distancia.toFixed(2)} km<br>
                            ${posto.endereco}
                        `);
                    markers.push(marker);
                });

                // Atualiza a lista e centraliza o mapa
                mostrarUnidadesProximas(unidadesProximas);
                map.setView([coords.lat, coords.lon], 14);
                mostrarFeedback('Unidades encontradas!', 'success');

            } catch (error) {
                mostrarFeedback(error.message, 'error');
                console.error('Erro:', error);
            }
        }

        // Busca por bairro
        async function buscarPostos() {
            const termoBusca = document.getElementById('bairro').value.toLowerCase();
            const resultadosDiv = document.getElementById('resultados');
            
            resultadosDiv.innerHTML = '';
            limparMarcadores();

            const postosFiltrados = termoBusca
                ? allPostos.filter(posto =>
                    posto.endereco.toLowerCase().includes(termoBusca) ||
                    posto.nome.toLowerCase().includes(termoBusca))
                : allPostos;

            if (postosFiltrados.length === 0) {
                mostrarFeedback('Nenhum posto encontrado', 'error');
                return;
            }

            postosFiltrados.forEach(posto => {
                const marker = L.marker([posto.latitude, posto.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <strong>${posto.nome}</strong><br>
                        ${posto.endereco}<br>
                        <em>Tipo: ${posto.tipo}</em>
                    `);
                markers.push(marker);
            });

            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
            mostrarFeedback(`${postosFiltrados.length} unidades encontradas`, 'success');
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function () {
            initMap();

            const cepInput = document.getElementById('cep');
            cepInput.addEventListener('input', function (e) {
                e.target.value = formatarCEP(e.target.value);
            });

            // Eventos de tecla Enter
            document.getElementById('bairro').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarPostos();
            });
            
            cepInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarPorCEP();
            });
        });
    </script>
</body>
</html>
